<div class="main">
  <p-toast [breakpoints]="{ '920px': { width: '90%', right: '', left: '0' } }" />

  <div class="customer-container">
    <!-- HEADER -->
    <header class="header">
      <div class="header-left">
        <h2>B√†n {{ tableID || '---' }}</h2>
        <p>Kh√°ch: {{ userData?.name || 'Kh√°ch m·ªõi' }}</p>
      </div>
      <div class="header-right">
        <button class="cart-btn" (click)="showCart = true">
          <i class="pi pi-shopping-cart"></i>
          <span *ngIf="cart.length" class="cart-badge">{{ cart.length }}</span>
        </button>
      </div>
    </header>

    <!-- NAVIGATION -->
    <nav class="bottom-nav">
      <div class="btn" (click)="activePage='profile'"><i class="pi pi-user"></i>C√° nh√¢n</div>
      <div class="btn" (click)="activePage='menu'"><i class="pi pi-book"></i>Th·ª±c ƒë∆°n</div>
      <div class="btn home" (click)="activePage='home'"><i class="pi pi-home"></i>Trang ch·ªß</div>
      <div class="btn" (click)="callStaff()"><i class="pi pi-bell"></i>G·ªçi nh√¢n vi√™n</div>
      <div class="btn" (click)="requestPayment()"><i class="pi pi-credit-card"></i>Thanh to√°n</div>
    </nav>

    <!-- PAGE CONTENT -->
    <main class="page-content">

      <!-- Trang Home -->
      <section *ngIf="activePage === 'home'" class="page home">
        <h3>Xin ch√†o {{ userData?.name || 'Qu√Ω kh√°ch' }} üëã</h3>
        <p>B·∫°n ƒëang ng·ªìi t·∫°i b√†n <b>{{ tableInfor?.table_name || '---' }}</b></p>
        <p>Ch·ªçn "Th·ª±c ƒë∆°n" ƒë·ªÉ b·∫Øt ƒë·∫ßu order nh√©!</p>
      </section>

      <!-- Trang Menu -->
      <section *ngIf="activePage === 'menu'" class="page menu">
        <!-- M√≥n ƒë·ªÅ xu·∫•t -->
        <div *ngIf="recomentDationData?.length" class="recommend-section">
          <h3>‚ú® G·ª£i √Ω cho b·∫°n</h3>
          <div class="menu-grid">
            <div *ngFor="let item of recomentDationData" class="menu-card" (click)="openDetail(item)">
              <img [src]="urlBackend + item.image_url" alt="{{ item.menu_name }}">
              <h4>{{ item.menu_name }}</h4>
              <strong>{{ item.price | currency:'VND':'symbol' }}</strong>
            </div>
          </div>
        </div>

        <!-- B·ªô l·ªçc -->
        <div class="category-bar">
          <button *ngFor="let cat of categoryOptions" (click)="selectedCategory = cat.value"
            [class.active]="selectedCategory===cat.value">
            {{ cat.label }}
          </button>
        </div>

        <!-- Menu theo danh m·ª•c -->
        <div *ngFor="let group of groupedMenuData" class="category-section"
          [hidden]="selectedCategory && selectedCategory !== group.categoryId">
          <h3>{{ group.categoryName }}</h3>
          <div class="menu-grid">
            <div *ngFor="let item of group.items" class="menu-card" (click)="openDetail(item)">
              <img [src]="urlBackend + item.image_url" alt="{{ item.menu_name }}">
              <h4>{{ item.menu_name }}</h4>
              <strong>{{ item.price | currency:'VND':'symbol' }}</strong>
            </div>
          </div>
        </div>
      </section>

      <!-- Trang Profile -->
      <section *ngIf="activePage === 'profile'" class="page profile">
        <h3>Th√¥ng tin c√° nh√¢n</h3>

        <!-- Avatar l·ªõn, full chi·ªÅu ngang -->
        <div class="profile-avatar">
          <img *ngIf="userData?.avatar; else defaultAvatar" [src]="urlBackend + userData?.avatar" alt="avatar">
          <ng-template #defaultAvatar>
            <div class="avatar-placeholder">·∫¢nh</div>
          </ng-template>
          <div class="edit-avatar-btn" (click)="changeAvatar()">
            <i class="pi pi-pencil"></i>
          </div>
        </div>

        <!-- Form th√¥ng tin -->
        <div class="profile-info" *ngIf="!isChangePass">
          <div class="form-field">
            <label for="">T√™n</label>
            <input pInputText [(ngModel)]="userData.full_name" placeholder="T√™n" [disabled]="!isEditing" />
          </div>

          <div class="form-field">
            <label for="">Email</label>
            <input pInputText [(ngModel)]="userData.email" placeholder="Email" [disabled]="!isEditing" />
          </div>

          <div class="form-field">
            <label for="">S·ªë ƒëi·ªán tho·∫°i</label>
            <input pInputText [(ngModel)]="userData.phone" placeholder="SƒêT" [disabled]="!isEditing" />
          </div>
        </div>

        <div class="changePass profile-info" *ngIf="isChangePass">
          <div class="form-field">
            <label for="">M·∫≠t kh·∫©u hi·ªán t·∫°i</label>
            <!-- <input pInputText [(ngModel)]="changePassData.oldPass" type="password" /> -->
            <p-password [(ngModel)]="changePassData.oldPass" [toggleMask]="true" [feedback]="false"/>
          </div>

          <div class="form-field">
            <label for="">M·∫≠t kh·∫©u m·ªõi</label>
              <p-password [(ngModel)]="changePassData.newPass" [toggleMask]="true" />
          </div>

          <div class="form-field">
            <label for="">X√°c nh·∫≠n m·∫≠t kh·∫©u m·ªõi</label>
            <p-password [(ngModel)]="changePassData.confirmNewPass" [toggleMask]="true" [feedback]="false"/>
          </div>
        </div>

        <div class="action">
          <p-button (onClick)="cancelEdit()" *ngIf="isEditing || isChangePass" severity="danger" size="small"
            label="Hu·ª∑"></p-button>
          <p-button (onClick)="toggleEdit()" [label]="isEditing ? 'L∆∞u' : 'C·∫≠p nh·∫≠t'"
            [icon]="isEditing ? 'pi pi-save' : 'pi pi-pencil'" [size]="'small'" *ngIf="!isChangePass"></p-button>
          <p-button (onClick)="toggleChangePass()" [label]="isChangePass ? 'ƒê·ªïi' : 'ƒê·ªïi m·∫≠t kh·∫©u'"
            [icon]="isChangePass ? 'pi pi-check' : 'pi pi-lock'" [size]="'small'" *ngIf="!isEditing"></p-button>
        </div>
      </section>

    </main>

    <!-- DIALOG chi ti·∫øt m√≥n -->
    <p-dialog header="{{ selectedItem?.menu_name }}" [(visible)]="showDetail" [modal]="true" [style]="{width:'90vw'}">
      <div *ngIf="selectedItem">
        <img [src]="urlBackend + selectedItem.image_url" alt="{{ selectedItem.menu_name }}"
          style="width:100%;border-radius:8px;">
        <p>{{ selectedItem.description }}</p>
        <h4>Gi√°: {{ selectedItem.price | currency:'VND':'symbol' }}</h4>
        <button title="addToCart" pButton type="button" label="+ Th√™m v√†o gi·ªè"
          (click)="addToCart(selectedItem)"></button>
      </div>
    </p-dialog>

    <!-- CART SIDEBAR -->
    <div class="cart-sidebar" [class.active]="showCart">
      <div class="cart-header">
        <h3>üõí Gi·ªè h√†ng</h3>
        <button class="close-btn" (click)="showCart=false">‚úñ</button>
      </div>

      <div class="cart-body">
        <div *ngIf="!cart.length" class="empty-cart">Gi·ªè h√†ng tr·ªëng.</div>

        <div *ngFor="let c of cart; let i = index" class="cart-item">
          <span>{{ c.menu_name }}</span>

          <div class="qty-controls">
            <button (click)="decreaseQuantity(i)">-</button>
            <span>{{ c.quantity }}</span>
            <button (click)="increaseQuantity(i)">+</button>
          </div>

          <i class="pi pi-trash" (click)="removeFromCart(i)"></i>
        </div>
      </div>

      <div class="cart-footer" *ngIf="cart.length">
        <h4>T·ªïng: {{ getCartTotal() | currency:'VND':'symbol' }}</h4>
        <button class="order-btn" (click)="submitOrder()">G·ª≠i Order</button>
      </div>
    </div>
  </div>

  <p-dialog header="Chi ti·∫øt Order" [(visible)]="showOrderDetail" [modal]="true" [style]="{width:'90vw'}">
    <div *ngIf="orderData" class="order-detail">
      <p><b>M√£ order:</b> {{ orderData.order_id }}</p>
      <p><b>Tr·∫°ng th√°i:</b> {{ getStatusLabel(orderData.status) }}</p>
      <p><b>Ng√†y t·∫°o:</b> {{ orderData.created_at | date:'short' }}</p>

      <h4>Danh s√°ch m√≥n:</h4>
      <ul class="order-items">
        <li *ngFor="let item of orderData.items">
          <div class="order-item-left">
            <img [src]="urlBackend + item.menu.image_url" alt="{{ item.menu.name }}">
            <span class="order-item-name">{{ item.menu.name }}</span>
          </div>
          <span class="order-item-qty">x{{ item.quantity }}</span>
        </li>
      </ul>

      <div class="order-total">
        T·ªïng ti·ªÅn: {{ orderData.total_price | currency:'VND':'symbol' }}
      </div>

      <div class="order-actions">
        <p-button label="Y√™u c·∫ßu thanh to√°n" icon="pi pi-credit-card" (click)="confirmPayment()"></p-button>
      </div>
    </div>
  </p-dialog>


</div>