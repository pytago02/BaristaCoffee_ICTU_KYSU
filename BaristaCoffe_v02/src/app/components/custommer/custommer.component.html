<div class="main">
  <p-toast [breakpoints]="{ '920px': { width: '90%', right: '', left: '0' } }" />

  <div class="chatbot-toggle" [class.active]="showChatbot"  (click)="toggleChatbot()">
    <i class="pi" [ngClass]="showChatbot ? 'pi-times' : 'pi-comments'"></i>
  </div>

  <div class="chatbot-popup" *ngIf="showChatbot">
    <app-chatbot></app-chatbot>
  </div>

  <div class="customer-container">
    <!-- HEADER -->
    <header class="header">
      <div class="header-left">
        <h2>B√†n {{ tableInfor?.table_name || '---' }}</h2>
        <p>Kh√°ch: {{ userData.full_name || 'Kh√°ch m·ªõi' }}</p>
      </div>
      <div class="header-right">
        <button class="cart-btn" (click)="showCart = true">
          <i class="pi pi-shopping-cart"></i>
          <span *ngIf="cart.length" class="cart-badge">{{ cart.length }}</span>
        </button>
      </div>
    </header>

    <!-- NAVIGATION -->
    <nav class="bottom-nav">
      <div class="btn" (click)="activePage='profile'"><i class="pi pi-user"></i>C√° nh√¢n</div>
      <div class="btn" (click)="activePage='menu'"><i class="pi pi-book"></i>Th·ª±c ƒë∆°n</div>
      <div class="btn home" (click)="activePage='home'"><i class="pi pi-home"></i>Trang ch·ªß</div>
      <div class="btn" (click)="callStaff()"><i class="pi pi-bell"></i>G·ªçi nh√¢n vi√™n</div>
      <div class="btn" (click)="requestPayment()"><i class="pi pi-credit-card"></i>Thanh to√°n</div>
    </nav>

    <!-- PAGE CONTENT -->
    <main class="page-content">

      <!-- Trang Home -->
      <section *ngIf="activePage === 'home'" class="page home">
        <div class="home-banner">
          <img src="bg-menu03.jpg" alt="Coffee Banner">
          <div class="banner-text">
            <h2>Ch√†o m·ª´ng {{ userData?.name || 'Qu√Ω kh√°ch' }}</h2>
            <p>B·∫°n ƒëang ng·ªìi t·∫°i b√†n <b>{{ tableInfor?.table_name || '---' }}</b></p>
            <p>H√£y ch·ªçn <b>‚ÄúTh·ª±c ƒë∆°n‚Äù</b> ƒë·ªÉ b·∫Øt ƒë·∫ßu order nh√©!</p>
          </div>
        </div>

        <div class="home-cards">
          <div class="card">
            <i class="pi pi-star"></i>
            <h4>C√† ph√™ ƒë·∫∑c bi·ªát</h4>
            <p>ƒê·∫≠m ƒë√† Nguy√™n ch·∫•t Tinh t·∫ø</p>
          </div>
          <div class="card">
            <i class="pi pi-heart"></i>
            <h4>B√°nh ng·ªçt handmade</h4>
            <p>Ng·ªçt ng√†o cho ng√†y th√™m vui</p>
          </div>
          <div class="card">
            <i class="pi pi-bell"></i>
            <h4>D·ªãch v·ª• t·∫≠n t√¨nh</h4>
            <p>Ch·ªâ c·∫ßn b·∫•m n√∫t, nh√¢n vi√™n s·∫Ω ƒë·∫øn ngay</p>
          </div>
        </div>

        <div class="store-info">
          <h3>‚òï Barista Coffee</h3>
          <p><i class="pi pi-map-marker"></i> Minh Ti·∫øn - ƒê·∫°i T·ª´ - Th√°i Nguy√™n</p>
          <p><i class="pi pi-phone"></i> 0898 284 203</p>
        </div>
      </section>


      <!-- Trang Menu -->
      <section *ngIf="activePage === 'menu'" class="page menu">
        <!-- M√≥n ƒë·ªÅ xu·∫•t -->
        <div *ngIf="recomentDationData?.length" class="recommend-section">
          <h3>‚ú® G·ª£i √Ω cho b·∫°n</h3>
          <div class="menu-grid">
            <div *ngFor="let item of recomentDationData" class="menu-card" (click)="openDetail(item)">
              <img [src]="urlBackend + item.image_url" alt="{{ item.menu_name }}">
              <h4>{{ item.menu_name }}</h4>
              <strong>{{ item.price | currency:'VND':'symbol' }}</strong>
            </div>
          </div>
        </div>

        <!-- B·ªô l·ªçc -->
        <div class="category-bar">
          <button *ngFor="let cat of categoryOptions" (click)="selectedCategory = cat.value"
            [class.active]="selectedCategory===cat.value">
            {{ cat.label }}
          </button>
        </div>

        <!-- Menu theo danh m·ª•c -->
        <div *ngFor="let group of groupedMenuData" class="category-section"
          [hidden]="selectedCategory && selectedCategory !== group.categoryId">
          <h3>{{ group.categoryName }}</h3>
          <div class="menu-grid">
            <div *ngFor="let item of group.items" class="menu-card" (click)="openDetail(item)">
              <img [src]="urlBackend + item.image_url" alt="{{ item.menu_name }}">
              <h4>{{ item.menu_name }}</h4>
              <strong>{{ item.price | currency:'VND':'symbol' }}</strong>
            </div>
          </div>
        </div>
      </section>

      <!-- Trang Profile -->
      <section *ngIf="activePage === 'profile'" class="page profile">
        <ng-container *ngIf="isLoggedIn; else notLoggedIn">
          <h3>Th√¥ng tin c√° nh√¢n</h3>

          <!-- Avatar -->
          <div class="profile-avatar">
            <img *ngIf="userData?.avatar; else defaultAvatar" [src]="urlBackend + userData?.avatar" alt="avatar">
            <ng-template #defaultAvatar>
              <div class="avatar-placeholder">·∫¢nh</div>
            </ng-template>
            <div class="edit-avatar-btn" (click)="changeAvatar()">
              <i class="pi pi-pencil"></i>
            </div>
          </div>

          <!-- Form th√¥ng tin -->
          <div class="profile-info" *ngIf="!isChangePass">
            <div class="form-field">
              <label for="">T√™n</label>
              <input pInputText [(ngModel)]="userData.full_name" placeholder="T√™n" [disabled]="!isEditing" />
            </div>

            <div class="form-field">
              <label for="">Email</label>
              <input pInputText [(ngModel)]="userData.email" placeholder="Email" [disabled]="!isEditing" />
            </div>

            <div class="form-field">
              <label for="">S·ªë ƒëi·ªán tho·∫°i</label>
              <input pInputText [(ngModel)]="userData.phone" placeholder="SƒêT" [disabled]="!isEditing" />
            </div>
          </div>

          <div class="changePass profile-info" *ngIf="isChangePass">
            <div class="form-field">
              <label for="">M·∫≠t kh·∫©u hi·ªán t·∫°i</label>
              <p-password [(ngModel)]="changePassData.oldPass" [toggleMask]="true" [feedback]="false" />
            </div>

            <div class="form-field">
              <label for="">M·∫≠t kh·∫©u m·ªõi</label>
              <p-password [(ngModel)]="changePassData.newPass" [toggleMask]="true" />
            </div>

            <div class="form-field">
              <label for="">X√°c nh·∫≠n m·∫≠t kh·∫©u m·ªõi</label>
              <p-password [(ngModel)]="changePassData.confirmNewPass" [toggleMask]="true" [feedback]="false" />
            </div>
          </div>

          <div class="action">
            <p-button (onClick)="cancelEdit()" *ngIf="isEditing || isChangePass" severity="danger" size="small"
              label="Hu·ª∑"></p-button>
            <p-button (onClick)="toggleEdit()" [label]="isEditing ? 'L∆∞u' : 'C·∫≠p nh·∫≠t'"
              [icon]="isEditing ? 'pi pi-save' : 'pi pi-pencil'" size="small" *ngIf="!isChangePass"></p-button>
            <p-button (onClick)="toggleChangePass()" [label]="isChangePass ? 'ƒê·ªïi' : 'ƒê·ªïi m·∫≠t kh·∫©u'"
              [icon]="isChangePass ? 'pi pi-check' : 'pi pi-lock'" size="small" *ngIf="!isEditing"></p-button>
            <p-button label="L·ªãch s·ª≠" icon="pi pi-history" size="small" severity="secondary"
              (click)="showHistoryOrder = true"></p-button>
          </div>

        </ng-container>

        <!-- N·∫øu ch∆∞a ƒëƒÉng nh·∫≠p -->
        <ng-template #notLoggedIn>
          <div class="not-logged-in">
            <h3>B·∫°n ch∆∞a ƒëƒÉng nh·∫≠p</h3>
            <p>Vui l√≤ng ƒëƒÉng nh·∫≠p ho·∫∑c t·∫°o t√†i kho·∫£n ƒë·ªÉ xem th√¥ng tin c√° nh√¢n.</p>
            <div class="btn-group">
              <p-button label="ƒêƒÉng nh·∫≠p" icon="pi pi-sign-in" (click)="showLogin = true"></p-button>
              <p-button label="ƒêƒÉng k√Ω" icon="pi pi-user-plus" severity="secondary"
                (click)="showRegister = true"></p-button>
            </div>
          </div>

          <!-- Form ƒëƒÉng nh·∫≠p -->
          <p-dialog header="ƒêƒÉng nh·∫≠p" [(visible)]="showLogin" [modal]="true" [dismissableMask]="true"
            [style]="{width:'400px'}">
            <div class="form-field">
              <label>Email</label>
              <input pInputText [(ngModel)]="loginData.identifier" placeholder="Nh·∫≠p email" />
            </div>
            <div class="form-field">
              <label>M·∫≠t kh·∫©u</label>
              <p-password [(ngModel)]="loginData.password" [feedback]="false"></p-password>
            </div>
            <div class="action" style="margin-top:15px;">
              <p-button label="ƒêƒÉng nh·∫≠p" (click)="login()" icon="pi pi-sign-in"></p-button>
            </div>
          </p-dialog>

          <!-- Form ƒëƒÉng k√Ω -->
          <p-dialog header="ƒêƒÉng k√Ω t√†i kho·∫£n" [(visible)]="showRegister" [modal]="true" [dismissableMask]="true"
            [style]="{width:'450px'}">
            <div class="form-field">
              <label>H·ªç t√™n</label>
              <input pInputText [(ngModel)]="registerData.full_name" placeholder="H·ªç v√† t√™n" />
            </div>
            <div class="form-field">
              <label>Email</label>
              <input pInputText [(ngModel)]="registerData.email" placeholder="Email" />
            </div>
            <div class="form-field">
              <label>S·ªë ƒëi·ªán tho·∫°i</label>
              <input pInputText [(ngModel)]="registerData.phone" placeholder="SƒêT" />
            </div>
            <div class="form-field">
              <label>M·∫≠t kh·∫©u</label>
              <p-password [(ngModel)]="registerData.password" [feedback]="false"></p-password>
            </div>
            <div class="action" style="margin-top:15px;">
              <p-button label="ƒêƒÉng k√Ω" (click)="register()" icon="pi pi-user-plus"></p-button>
            </div>
          </p-dialog>
        </ng-template>

      </section>


    </main>

    <!-- DIALOG chi ti·∫øt m√≥n -->
    <p-dialog header="{{ selectedItem?.menu_name }}" [(visible)]="showDetail" [modal]="true" [style]="{height:'90vh'}">
      <div *ngIf="selectedItem">
        <img [src]="urlBackend + selectedItem.image_url" alt="{{ selectedItem.menu_name }}"
          style="width:100%;border-radius:8px;">
        <p>{{ selectedItem.description }}</p>
        <h4>Gi√°: {{ selectedItem.price | currency:'VND':'symbol' }}</h4>
        <button title="addToCart" pButton type="button" label="+ Th√™m v√†o gi·ªè"
          (click)="addToCart(selectedItem)"></button>
      </div>
    </p-dialog>

    <!-- CART SIDEBAR -->
    <div class="cart-sidebar" [class.active]="showCart">
      <div class="cart-header">
        <h3>üõí Gi·ªè h√†ng</h3>
        <button class="close-btn" (click)="showCart=false">‚úñ</button>
      </div>

      <div class="cart-body">
        <div *ngIf="!cart.length" class="empty-cart">Gi·ªè h√†ng tr·ªëng.</div>

        <div *ngFor="let c of cart; let i = index" class="cart-item">
          <span>{{ c.menu_name }}</span>

          <div class="qty-controls">
            <button (click)="decreaseQuantity(i)">-</button>
            <span>{{ c.quantity }}</span>
            <button (click)="increaseQuantity(i)">+</button>
          </div>

          <i class="pi pi-trash" (click)="removeFromCart(i)"></i>
        </div>
      </div>

      <div class="cart-footer" *ngIf="cart.length">
        <h4>T·ªïng: {{ getCartTotal() | currency:'VND':'symbol' }}</h4>
        <button class="order-btn" (click)="submitOrder()">G·ª≠i Order</button>
      </div>
    </div>
  </div>

  <p-dialog header="Chi ti·∫øt Order" [(visible)]="showOrderDetail" [modal]="true" [style]="{width:'90vw'}">
    <div *ngIf="orderData" class="order-detail">
      <p><b>M√£ order:</b> {{ orderData.order_id }}</p>
      <p><b>Tr·∫°ng th√°i:</b> {{ getStatusLabel(orderData.status) }}</p>
      <p><b>Ng√†y t·∫°o:</b> {{ orderData.created_at | date:'short' }}</p>

      <!-- <h4>Danh s√°ch m√≥n:</h4> -->
      <ul class="order-items">
        <li *ngFor="let item of orderData.items">
          <div class="order-item-left">
            <img [src]="urlBackend + item.menu.image_url" alt="{{ item.menu.name }}">
            <span class="order-item-name">{{ item.menu.name }}</span>
          </div>
          <span class="order-item-qty">x{{ item.quantity }}</span>
        </li>
      </ul>

      <div class="order-total">
        T·ªïng ti·ªÅn: {{ orderData.total_price | currency:'VND':'symbol' }}
      </div>

      <div class="order-actions">
        <p-button label="Y√™u c·∫ßu thanh to√°n" icon="pi pi-credit-card" (click)="confirmPayment()"></p-button>
      </div>
    </div>
  </p-dialog>

  <p-dialog header="L·ªãch s·ª≠ order" [(visible)]="showHistoryOrder" [modal]="true" [style]="{width:'90vw'}">
    <div *ngIf="historyOrder?.length; else noHistory">
      <table class="order-history-table">
        <thead>
          <tr>
            <th>M√£ Order</th>
            <th>Ng√†y</th>
            <th>T·ªïng ti·ªÅn</th>
          </tr>
        </thead>
        <tbody *ngFor="let order of historyOrder">
          <tr (click)="openOrderDetail(order)">
            <td>{{ order.order_id }}</td>
            <td>{{ order.order_date | date:'short' }}</td>
            <td>{{ order.total_price | currency:'VND':'symbol' }}</td>
          </tr>

          <tr *ngIf="selectedOrder && selectedOrder.order_id === order.order_id">
            <td colspan="3">
              <div class="order-detail">
                <p><b>B√†n:</b> {{ order.table_name }} ({{ order.zone_name }})</p>

                <table class="order-items-table">
                  <thead>
                    <tr>
                      <th>M√≥n</th>
                      <th>S·ªë l∆∞·ª£ng</th>
                      <th>T·ªïng</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr *ngFor="let item of order.items">
                      <td>
                        {{ item.menu_item }}
                      </td>
                      <td>x{{ item.quantity }}</td>
                      <td>{{ item.item_total | currency:'VND':'symbol' }}</td>
                    </tr>
                  </tbody>
                </table>

                <!-- <div class="order-total" style="text-align:right; margin-top:8px;">
                  <b>T·ªïng c·ªông: {{ order.total_price | currency:'VND':'symbol' }}</b>
                </div> -->
              </div>
            </td>
          </tr>

        </tbody>
      </table>
    </div>

    <ng-template #noHistory>
      <p>Ch∆∞a c√≥ l·ªãch s·ª≠ ƒë∆°n h√†ng n√†o.</p>
    </ng-template>
  </p-dialog>



</div>