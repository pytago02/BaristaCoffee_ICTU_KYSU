<div class="main">
  <p-toast [breakpoints]="{ '920px': { width: '90%', right: '', left: '0' } }" />

  <div class="chatbot-toggle" [class.active]="showChatbot"  (click)="toggleChatbot()">
    <i class="pi" [ngClass]="showChatbot ? 'pi-times' : 'pi-comments'"></i>
  </div>

  <div class="chatbot-popup" *ngIf="showChatbot">
    <app-chatbot></app-chatbot>
  </div>

  <div class="customer-container">
    <!-- HEADER -->
    <header class="header">
      <div class="header-left">
        <h2>Bàn {{ tableInfor?.table_name || '---' }}</h2>
        <p>Khách: {{ userData.full_name || 'Khách mới' }}</p>
      </div>
      <div class="header-right">
        <button class="cart-btn" (click)="showCart = true">
          <i class="pi pi-shopping-cart"></i>
          <span *ngIf="cart.length" class="cart-badge">{{ cart.length }}</span>
        </button>
      </div>
    </header>

    <!-- NAVIGATION -->
    <nav class="bottom-nav">
      <div class="btn" (click)="activePage='profile'"><i class="pi pi-user"></i>Cá nhân</div>
      <div class="btn" (click)="activePage='menu'"><i class="pi pi-book"></i>Thực đơn</div>
      <div class="btn home" (click)="activePage='home'"><i class="pi pi-home"></i>Trang chủ</div>
      <div class="btn" (click)="callStaff()"><i class="pi pi-bell"></i>Gọi nhân viên</div>
      <div class="btn" (click)="requestPayment()"><i class="pi pi-credit-card"></i>Thanh toán</div>
    </nav>

    <!-- PAGE CONTENT -->
    <main class="page-content">

      <!-- Trang Home -->
      <section *ngIf="activePage === 'home'" class="page home">
        <div class="home-banner">
          <img src="bg-menu03.jpg" alt="Coffee Banner">
          <div class="banner-text">
            <h2>Chào mừng {{ userData?.name || 'Quý khách' }}</h2>
            <p>Bạn đang ngồi tại bàn <b>{{ tableInfor?.table_name || '---' }}</b></p>
            <p>Hãy chọn <b>“Thực đơn”</b> để bắt đầu order nhé!</p>
          </div>
        </div>

        <div class="home-cards">
          <div class="card">
            <i class="pi pi-star"></i>
            <h4>Cà phê đặc biệt</h4>
            <p>Đậm đà Nguyên chất Tinh tế</p>
          </div>
          <div class="card">
            <i class="pi pi-heart"></i>
            <h4>Bánh ngọt handmade</h4>
            <p>Ngọt ngào cho ngày thêm vui</p>
          </div>
          <div class="card">
            <i class="pi pi-bell"></i>
            <h4>Dịch vụ tận tình</h4>
            <p>Chỉ cần bấm nút, nhân viên sẽ đến ngay</p>
          </div>
        </div>

        <div class="store-info">
          <h3>☕ Barista Coffee</h3>
          <p><i class="pi pi-map-marker"></i> Minh Tiến - Đại Từ - Thái Nguyên</p>
          <p><i class="pi pi-phone"></i> 0898 284 203</p>
        </div>
      </section>


      <!-- Trang Menu -->
      <section *ngIf="activePage === 'menu'" class="page menu">
        <!-- Món đề xuất -->
        <div *ngIf="recomentDationData?.length" class="recommend-section">
          <h3>✨ Gợi ý cho bạn</h3>
          <div class="menu-grid">
            <div *ngFor="let item of recomentDationData" class="menu-card" (click)="openDetail(item)">
              <img [src]="urlBackend + item.image_url" alt="{{ item.menu_name }}">
              <h4>{{ item.menu_name }}</h4>
              <strong>{{ item.price | currency:'VND':'symbol' }}</strong>
            </div>
          </div>
        </div>

        <!-- Bộ lọc -->
        <div class="category-bar">
          <button *ngFor="let cat of categoryOptions" (click)="selectedCategory = cat.value"
            [class.active]="selectedCategory===cat.value">
            {{ cat.label }}
          </button>
        </div>

        <!-- Menu theo danh mục -->
        <div *ngFor="let group of groupedMenuData" class="category-section"
          [hidden]="selectedCategory && selectedCategory !== group.categoryId">
          <h3>{{ group.categoryName }}</h3>
          <div class="menu-grid">
            <div *ngFor="let item of group.items" class="menu-card" (click)="openDetail(item)">
              <img [src]="urlBackend + item.image_url" alt="{{ item.menu_name }}">
              <h4>{{ item.menu_name }}</h4>
              <strong>{{ item.price | currency:'VND':'symbol' }}</strong>
            </div>
          </div>
        </div>
      </section>

      <!-- Trang Profile -->
      <section *ngIf="activePage === 'profile'" class="page profile">
        <ng-container *ngIf="isLoggedIn; else notLoggedIn">
          <h3>Thông tin cá nhân</h3>

          <!-- Avatar -->
          <div class="profile-avatar">
            <img *ngIf="userData?.avatar; else defaultAvatar" [src]="urlBackend + userData?.avatar" alt="avatar">
            <ng-template #defaultAvatar>
              <div class="avatar-placeholder">Ảnh</div>
            </ng-template>
            <div class="edit-avatar-btn" (click)="changeAvatar()">
              <i class="pi pi-pencil"></i>
            </div>
          </div>

          <!-- Form thông tin -->
          <div class="profile-info" *ngIf="!isChangePass">
            <div class="form-field">
              <label for="">Tên</label>
              <input pInputText [(ngModel)]="userData.full_name" placeholder="Tên" [disabled]="!isEditing" />
            </div>

            <div class="form-field">
              <label for="">Email</label>
              <input pInputText [(ngModel)]="userData.email" placeholder="Email" [disabled]="!isEditing" />
            </div>

            <div class="form-field">
              <label for="">Số điện thoại</label>
              <input pInputText [(ngModel)]="userData.phone" placeholder="SĐT" [disabled]="!isEditing" />
            </div>
          </div>

          <div class="changePass profile-info" *ngIf="isChangePass">
            <div class="form-field">
              <label for="">Mật khẩu hiện tại</label>
              <p-password [(ngModel)]="changePassData.oldPass" [toggleMask]="true" [feedback]="false" />
            </div>

            <div class="form-field">
              <label for="">Mật khẩu mới</label>
              <p-password [(ngModel)]="changePassData.newPass" [toggleMask]="true" />
            </div>

            <div class="form-field">
              <label for="">Xác nhận mật khẩu mới</label>
              <p-password [(ngModel)]="changePassData.confirmNewPass" [toggleMask]="true" [feedback]="false" />
            </div>
          </div>

          <div class="action">
            <p-button (onClick)="cancelEdit()" *ngIf="isEditing || isChangePass" severity="danger" size="small"
              label="Huỷ"></p-button>
            <p-button (onClick)="toggleEdit()" [label]="isEditing ? 'Lưu' : 'Cập nhật'"
              [icon]="isEditing ? 'pi pi-save' : 'pi pi-pencil'" size="small" *ngIf="!isChangePass"></p-button>
            <p-button (onClick)="toggleChangePass()" [label]="isChangePass ? 'Đổi' : 'Đổi mật khẩu'"
              [icon]="isChangePass ? 'pi pi-check' : 'pi pi-lock'" size="small" *ngIf="!isEditing"></p-button>
            <p-button label="Lịch sử" icon="pi pi-history" size="small" severity="secondary"
              (click)="showHistoryOrder = true"></p-button>
          </div>

        </ng-container>

        <!-- Nếu chưa đăng nhập -->
        <ng-template #notLoggedIn>
          <div class="not-logged-in">
            <h3>Bạn chưa đăng nhập</h3>
            <p>Vui lòng đăng nhập hoặc tạo tài khoản để xem thông tin cá nhân.</p>
            <div class="btn-group">
              <p-button label="Đăng nhập" icon="pi pi-sign-in" (click)="showLogin = true"></p-button>
              <p-button label="Đăng ký" icon="pi pi-user-plus" severity="secondary"
                (click)="showRegister = true"></p-button>
            </div>
          </div>

          <!-- Form đăng nhập -->
          <p-dialog header="Đăng nhập" [(visible)]="showLogin" [modal]="true" [dismissableMask]="true"
            [style]="{width:'400px'}">
            <div class="form-field">
              <label>Email</label>
              <input pInputText [(ngModel)]="loginData.identifier" placeholder="Nhập email" />
            </div>
            <div class="form-field">
              <label>Mật khẩu</label>
              <p-password [(ngModel)]="loginData.password" [feedback]="false"></p-password>
            </div>
            <div class="action" style="margin-top:15px;">
              <p-button label="Đăng nhập" (click)="login()" icon="pi pi-sign-in"></p-button>
            </div>
          </p-dialog>

          <!-- Form đăng ký -->
          <p-dialog header="Đăng ký tài khoản" [(visible)]="showRegister" [modal]="true" [dismissableMask]="true"
            [style]="{width:'450px'}">
            <div class="form-field">
              <label>Họ tên</label>
              <input pInputText [(ngModel)]="registerData.full_name" placeholder="Họ và tên" />
            </div>
            <div class="form-field">
              <label>Email</label>
              <input pInputText [(ngModel)]="registerData.email" placeholder="Email" />
            </div>
            <div class="form-field">
              <label>Số điện thoại</label>
              <input pInputText [(ngModel)]="registerData.phone" placeholder="SĐT" />
            </div>
            <div class="form-field">
              <label>Mật khẩu</label>
              <p-password [(ngModel)]="registerData.password" [feedback]="false"></p-password>
            </div>
            <div class="action" style="margin-top:15px;">
              <p-button label="Đăng ký" (click)="register()" icon="pi pi-user-plus"></p-button>
            </div>
          </p-dialog>
        </ng-template>

      </section>


    </main>

    <!-- DIALOG chi tiết món -->
    <p-dialog header="{{ selectedItem?.menu_name }}" [(visible)]="showDetail" [modal]="true" [style]="{height:'90vh'}">
      <div *ngIf="selectedItem">
        <img [src]="urlBackend + selectedItem.image_url" alt="{{ selectedItem.menu_name }}"
          style="width:100%;border-radius:8px;">
        <p>{{ selectedItem.description }}</p>
        <h4>Giá: {{ selectedItem.price | currency:'VND':'symbol' }}</h4>
        <button title="addToCart" pButton type="button" label="+ Thêm vào giỏ"
          (click)="addToCart(selectedItem)"></button>
      </div>
    </p-dialog>

    <!-- CART SIDEBAR -->
    <div class="cart-sidebar" [class.active]="showCart">
      <div class="cart-header">
        <h3>🛒 Giỏ hàng</h3>
        <button class="close-btn" (click)="showCart=false">✖</button>
      </div>

      <div class="cart-body">
        <div *ngIf="!cart.length" class="empty-cart">Giỏ hàng trống.</div>

        <div *ngFor="let c of cart; let i = index" class="cart-item">
          <span>{{ c.menu_name }}</span>

          <div class="qty-controls">
            <button (click)="decreaseQuantity(i)">-</button>
            <span>{{ c.quantity }}</span>
            <button (click)="increaseQuantity(i)">+</button>
          </div>

          <i class="pi pi-trash" (click)="removeFromCart(i)"></i>
        </div>
      </div>

      <div class="cart-footer" *ngIf="cart.length">
        <h4>Tổng: {{ getCartTotal() | currency:'VND':'symbol' }}</h4>
        <button class="order-btn" (click)="submitOrder()">Gửi Order</button>
      </div>
    </div>
  </div>

  <p-dialog header="Chi tiết Order" [(visible)]="showOrderDetail" [modal]="true" [style]="{width:'90vw'}">
    <div *ngIf="orderData" class="order-detail">
      <p><b>Mã order:</b> {{ orderData.order_id }}</p>
      <p><b>Trạng thái:</b> {{ getStatusLabel(orderData.status) }}</p>
      <p><b>Ngày tạo:</b> {{ orderData.created_at | date:'short' }}</p>

      <!-- <h4>Danh sách món:</h4> -->
      <ul class="order-items">
        <li *ngFor="let item of orderData.items">
          <div class="order-item-left">
            <img [src]="urlBackend + item.menu.image_url" alt="{{ item.menu.name }}">
            <span class="order-item-name">{{ item.menu.name }}</span>
          </div>
          <span class="order-item-qty">x{{ item.quantity }}</span>
        </li>
      </ul>

      <div class="order-total">
        Tổng tiền: {{ orderData.total_price | currency:'VND':'symbol' }}
      </div>

      <div class="order-actions">
        <p-button label="Yêu cầu thanh toán" icon="pi pi-credit-card" (click)="confirmPayment()"></p-button>
      </div>
    </div>
  </p-dialog>

  <p-dialog header="Lịch sử order" [(visible)]="showHistoryOrder" [modal]="true" [style]="{width:'90vw'}">
    <div *ngIf="historyOrder?.length; else noHistory">
      <table class="order-history-table">
        <thead>
          <tr>
            <th>Mã Order</th>
            <th>Ngày</th>
            <th>Tổng tiền</th>
          </tr>
        </thead>
        <tbody *ngFor="let order of historyOrder">
          <tr (click)="openOrderDetail(order)">
            <td>{{ order.order_id }}</td>
            <td>{{ order.order_date | date:'short' }}</td>
            <td>{{ order.total_price | currency:'VND':'symbol' }}</td>
          </tr>

          <tr *ngIf="selectedOrder && selectedOrder.order_id === order.order_id">
            <td colspan="3">
              <div class="order-detail">
                <p><b>Bàn:</b> {{ order.table_name }} ({{ order.zone_name }})</p>

                <table class="order-items-table">
                  <thead>
                    <tr>
                      <th>Món</th>
                      <th>Số lượng</th>
                      <th>Tổng</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr *ngFor="let item of order.items">
                      <td>
                        {{ item.menu_item }}
                      </td>
                      <td>x{{ item.quantity }}</td>
                      <td>{{ item.item_total | currency:'VND':'symbol' }}</td>
                    </tr>
                  </tbody>
                </table>

                <!-- <div class="order-total" style="text-align:right; margin-top:8px;">
                  <b>Tổng cộng: {{ order.total_price | currency:'VND':'symbol' }}</b>
                </div> -->
              </div>
            </td>
          </tr>

        </tbody>
      </table>
    </div>

    <ng-template #noHistory>
      <p>Chưa có lịch sử đơn hàng nào.</p>
    </ng-template>
  </p-dialog>



</div>